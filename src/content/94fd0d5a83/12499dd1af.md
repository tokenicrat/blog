---
title: "sing-box 白话文指南（一）"
summary: "VPS 基础配置和安全防护"
topics: ["科学上网"]
date: "2025-07-12T10:30:24+08:00"
draft: false
katex: false
typora-root-url: ../../static
typora-copy-images-to: ../../static/img/${filename}
---

章节目标：

- 对 VPS 进行基础配置，安装常用软件。
- 修改 SSH 配置，提升安全防护。

说明：上一节词元建议您使用 Rocky Linux 9，主要是出于稳定和精简，本节关于包管理器的操作将假设您使用 Rocky Linux 9（或任何 EL 9 兼容发行版，如 AlmaLinux 9）。若您计划使用 Debian 系发行版，词元将在附录中简要介绍。

## 连接 VPS

在上一节中，您应该已经记录了服务器的登录信息，包括 SSH 用户名、密码、端口号、私钥等，某些商家可能还会提供管理面板的账号、密码。由于管理面板和 WebSSH 种类繁多、操作迥异，词元只介绍通用的 SSH；如果要使用管理面板，请参考商家文档。

### 什么是 SSH

VPS 远在大洋彼岸，您大概没法铺设 HDMI 海底电缆接显示器操作，所以需要远程登录。

在那个「传输一律明文、相信你是好人」的时代，Telnet 是最常用的远程登录工具。Telnet 没有加密，很容易泄露包括密码在内的数据，这肯定是不行的。

非对称式加密，作为现代互联网「万物加密」的基石，保证了 SSH 的安全。非对称式加密的原理颇为复杂，一个简化的版本是：

- 使用两把密钥——公钥和私钥。根据私钥可以轻易推出公钥，反之则非常困难。
- 公钥加密，只有私钥可以解开；私钥加密，只有公钥可以解开。
- 假设 A 要发送数据给 B：
  - A 向 B 提出要发送数据，B 将自己的公钥提供给 A。
  - A 使用 B 的公钥加密数据，发送密文。
  - 中间人 C 拦截了所有数据包，但是只有 B 的公钥是公开的。刚刚提到，B 的公钥加密数据，只有 B 的私钥可以解开。因此，C 无法解密。
  - B 收到了 A 发送的密文，用自己的私钥解开。

关于非对称式加密的具体实现和原理超出了本教程的范围，如果有兴趣，可以阅读本节参考资料。

言归正传，在 SSH 连接前，服务、客户两端先交换公钥，双向加密，保障了通信安全。若没有特殊设置，双端公私钥均为随机生成；如果提前将固定的公钥提供给服务端，用公钥加密发送的数据，您自己保留私钥，那就只有您可以解密服务端发送的数据。

> 参考资料：
>
> - [公开密钥加密](https://zh.wikipedia.org/wiki/%E5%85%AC%E5%BC%80%E5%AF%86%E9%92%A5%E5%8A%A0%E5%AF%86)
> - [RSA 加密演算法](https://zh.wikipedia.org/zh-hans/RSA%E5%8A%A0%E5%AF%86%E6%BC%94%E7%AE%97%E6%B3%95)（一种常用的非对称式加密算法）
> - [Secure Shell](https://zh.wikipedia.org/wiki/Secure_Shell)

### 开工

大多数 Linux 发行版、Windows 10 1803 及更新版本、macOS 均包含 OpenSSH（一个开源 SSH 客户端实现，由 OpenBSD 开发者开发）。执行 `ssh -V` 可以验证您是否已经安装了 OpenSSH。[^1]

[^1]: 在 Windows 上，请打开终端应用或 PowerShell；在 macOS 上，请打开终端应用；在 Linux 上，相信您会打开正确的应用。

如果您看到了版本号，说明可用，执行以下命令，用 SSH 连接 VPS！

```bash
ssh USER_NAME@IP [-p PORT] [-i PRIVATE_KEY]
```

其中：

- `USER_NAME`：用户名，`root` 或商家指定的。
- `IP`：VPS 的 IP 地址。
- `-p PORT`：可选，若商家没有指定端口，可以省略。
- `-i PRIVATE_KEY`：可选，若商家提供了私钥，需要下载并指定。

首次连接会出现信任密钥的提示，输入 `yes` 即可，服务器公钥将被记录在 `.ssh/known_hosts` 中。然后输入密码（注意不显示）。

如果您没有看到输入密码的提示，而是看到了：

- `ssh: connect to host IP port PORT: No route to host`：端口号或 IP 错误，~~或者服务器没开机~~。
- `USER_NAME@IP: Permission denied (publickey,gssapi-keyex,gssapi-with-mic).`：密码登录被禁用，检查是否提供了私钥。

出现命令提示符，如 `[root@vps ~]$`，则连接成功，恭喜 🎉

## 安全措施

### 账户和 SSH

登录后第一件事，应该是修改 root 密码并添加普通账号（如果商家没有提供）。

```bash
passwd root # 输入新密码
useradd -m -G wheel admin # 新建用户并授予 sudo 权限；假设新用户名为 admin，可以自选
passwd admin # 输入密码
```

密码越复杂越好，建议 15 位以上的字母、数字、符号混合。

然后用新创建的账户登录，并测试 sudo 是否可用。sudo 可以临时以 root 权限执行命令。

```bash
su - admin
sudo dnf version # 注意提示符变为 $；输入密码，输出 DNF 版本号即为成功
```

同时可以开一个新的终端，用新的账户尝试登录，测试是否可用。

刚刚的知识部分提到了，如果只使用密码，公私钥对是随机生成的。如果攻击者获取（猜出）密码就能登录。使用自己生成的固定密钥可以添加额外的安全性。

以下在 **本机终端** 执行，先生成密钥对。

```bash
ssh-keygen -t ed25519 # 可以自选保存位置，建议设置复杂密码
```

EdDSA 是一种更加安全 ~~和复杂~~ 的非对称式加密算法，新版 SSH 已经将其作为默认。

![image-20250714211847861](/img/12499dd1af/image-20250714211847861.png)

然后，将证书安装到 VPS。这里假设您 VPS 的 IP 为 100.200.300.400（根据实际情况替换），密钥保存在默认位置。

```bash
ssh-copy-id -i .ssh/id_ed25519.pub admin@100.200.300.400 # 需要输入 admin 的密码
```

安装完成后，尝试使用密钥登录。

```bash
ssh -i .ssh/id_ed25519 [-p PORT] admin@100.200.300.400 # 非 22 端口要指定
```

如果您可以通过 **密钥密码**（`ssh-keygen` 这一步输入的）登录，说明安装成功。

同时您还需要禁用密码登录（不然这堆事白干了），用 SSH 登录到 VPS，然后修改 `/etc/ssh/sshd_config`（SSH 的配置）。

```bash
sudo nano /etc/sshd_config
```

GNU Nano 是一个简单的文本编辑器，在界面下方有快捷键列表，例如 Ctrl-X 可以退出（选择是否保存）。Nano 操作简单，相应功能和效率较低，接下来我们会学习 Vim 的简单使用。

![image-20250714210930041](/img/12499dd1af/image-20250714210930041.png)

打开文件之后，找到（或添加）以下配置：

```
PasswordAuthentication no
PermitRootLogin no
AllowUsers admin # 禁止除 admin 之外的用户登录，可选
```

然后重启 SSH 服务。

```bash
sudo systemctl restart sshd
```

先不要关闭当前 SSH 连接（这可能导致无法连接）！打开一个新终端，尝试使用密钥连接，并尝试使用密码。若前者成功，后者出现类似报错：

```
admin@100.200.300.400: Permission denied (publickey).
```

则设置成功，安心地关闭 SSH 吧。

![image-20250714211644842](/img/12499dd1af/image-20250714211644842.png)

### 可选：更改端口

以上措施已经基本杜绝未授权登录，但是有些人喜欢扫 22 端口，每次启动都会看到一堆失败的登录，很难受。因此我们可以修改 SSH 端口。

开始之前，先检查防火墙是否开启：

```bash
sudo systemctl status firewalld # 或 ufw
```

若输出 `Active` 则暂时不要更换端口，看完下面防火墙一节再回来做；如果报错、输出 `Inactive` 则可以操作。

修改 `/etc/ssh/sshd_config`，将 `Port 22` 取消注释并修改为任意端口，例如 `28822`、`19622` 等等，随便。然后同上，重启 `sshd` 服务即可。

### 更新

保持系统更新可以提升系统安全性。

Rocky Linux 使用 DNF 管理软件包的安装、更新和移除。

```bash
sudo dnf update
```

注意，如果您购买了 RackNerd 的 VPS，预装的 Rocky Linux 第一次更新需要移除 `network-scripts` 并换用 `network-manager`。

```bash
sudo dnf update --allowerasing # 允许移除软件包
```

然后，您需要立即启动 Network Manager，否则断开 SSH 连接后无法重新连接。

```bash
sudo systemctl enable --now NetworkManager # 表示自动启动且立即启动
```

重启，等待一会儿重新连接 SSH。

```bash
sudo reboot
```

### 设置防火墙和 Fail2Ban

防火墙可以根据您的设置，拦截或放行特定端口的流量。词元将使用 Firewalld 作为防火墙演示。某些 VPS 预装 UFW，您可以自行查找文档，或卸载并换用 Firewalld。

先安装 Firewalld。

```bash
sudo dnf install firewalld
sudo systemctl enable --now firewalld
```

如果您刚刚更改了 SSH 端口，**切勿切断连接**，添加以下步骤：

```bash
sudo cp /usr/lib/firewalld/services/ssh.xml /etc/firewalld/services/ssh.xml # 复制默认配置；cp FROM TO
sudo nano /etc/firewalld/services/ssh.xml # 将文件中的端口号改为 SSH 端口号
sudo firewall-cmd --reload
```

然后，同样不要关闭当前 SSH 连接，测试可用后再关闭。

Fail2Ban 可以自动将失败尝试过多、访问频率过高的客户端 IP 屏蔽，有助于防止暴力尝试密码。其开箱即用，很简单。在 Rocky Linux 中 Fail2Ban 在 EPEL 源中，需要先启用。

```bash
sudo dnf config-manager --set-enabled crb
sudo dnf install epel-release
sudo dnf install fail2ban
sudo systemctl enable --now fail2ban
```

### 安装常用软件包

```bash
sudo dnf install vim git podman podman-compose podman-docker bash-completion
sudo systemctl enable --now podman
```

以上软件包在接下来几节中将使用。

## 恭喜

本节您完成了 VPS 的基本配置和安全加固，您的 VPS 攻击成本——价值比越来越高了！
