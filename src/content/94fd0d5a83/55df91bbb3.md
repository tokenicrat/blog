---
title: "sing-box 服务端配置文件示例"
summary: "三种协议入站，分流 Warp 解锁出站，完整注释"
topics: ["sing-box"]
date: "2025-07-15T13:06:16+08:00"
draft: false
katex: false
typora-root-url: ../../static
typora-copy-images-to: ../../static/img/${filename}
---

JSON 可读性本来就差，加上表述模糊的 [文档](https://sing-box.sagernet.org/zh/configuration/)，sing-box 的配置文件是出了名的难写。词元冲着通用和高性能换用 sing-box，上来先被硬控半小时，才写出可用且满意的配置。

为了悼念死去的脑细胞，特记录如下。

## 概述

主要是三部分：

- DNS：DoH 解析
- 出站：禁止回国流量，Warp 分流解锁部分站点
- 进站：Hysteria2（高速，常用），VLESS-Vision-Reality（QoS 严重时使用），VMess-WebSocket-TLS（套 CDN，防失联）

sing-box 只支持 JSON 格式配置文件。但是 JSON 可读性很差，还不支持注释，因此本文词元用 YAML 格式书写。在测试前，您可以使用 [转换工具](https://jsonformatter.org/yaml-to-json) 翻译。

## 配置文件

`/etc/sing-box/config.json`（转换前）：

```yaml
log:
  level: warn # 调试时修改为 debug

dns:
  servers:
  # 自行选择 DNS 服务器，1.1.1.1 和 Google Public DNS 解析速度较快
  # 境外 DNS 污染不严重，DoH 可选
  - tag: Cloudflare DNS (DoH)
    address: https://1.1.1.1/dns-query
  - tag: Google Public DNS (DoH)
    address: https://dns.google/dns-query
    address_resolver: Cloudflare DNS (DoH)
    # 只有 IPv4 的 VPS 需要取消注释下面 2 行
    # address_strategy: ipv4_only
  # strategy: ipv4_only
  final: Cloudflare DNS (DoH)

route:
  auto_detect_interface: true # 可选，防止 TUN 回环
  final: direct # 默认直连出站
  rules:
  - ip_is_private: true # 禁止局域网 IP
    action: reject
  - protocol:
    - dns # 拦截 DNS 请求，走上面的 DNS 配置
    action: hijack-dns
  - rule_set:
    - geosite-cn # 禁止回国
    action: reject
  # VPS 送中可以启用下面 4 行
  # - rule_set:
  #   - geosite-google
  #   action: route
  #   outbound: warp
  rule_set: # 每次重启自动更新规则集
  - tag: geosite-cn
    type: remote
    format: binary
    url: https://github.com/SagerNet/sing-geosite/raw/refs/heads/rule-set/geosite-cn.srs
  - tag: geosite-google
    type: remote
    format: binary
    url: https://github.com/SagerNet/sing-geosite/raw/refs/heads/rule-set/geosite-google.srs

outbounds:
- tag: direct
  type: direct
# 需要 Warp 客户端以代理模式运行，自行修改端口
# - tag: warp
#   type: socks
#   server: 127.0.0.1
#   server_port: 6123

inbounds:
# 1. Hysteria2 协议进站
- type: hysteria2
  tag: HY2
  listen: 0.0.0.0
  listen_port: 7777
  sniff: true # 嗅探域名，否则分流是无效的
  up_mbps: 100
  down_mbps: 100 # 设置目标速率
  obfs:
    type: salamander
    # 所有随机字符串自行使用 openssl rand -hex 16 生成
    password: 41200558e86d658673591ab8f1e6d31a
  users:
  - password: de4bdbac5b131cfbd1902c192f207958
  tls:
    enabled: true # TLS 证书，可以用 acme.sh 自动申请
    certificate_path: "/var/cert/example.com/public.crt"
    key_path: "/var/cert/example.com/private.key"
    alpn:
    - h3
  # 反代伪装站点
  # 这个站点不需要支持 HTTP/3，但是反代结果仅支持 HTTP/3 访问
  masquerade: https://geo.mirror.pkgbuild.com/
# 2. VMess-WebSocket-TLS 协议进站
# 需要结合下文 NGiNX 配置套 Cloudflare DNS 使用
- type: vmess
  tag: VM-WS-T-CF
  listen: 127.0.0.1
  listen_port: 6666
  sniff: true
  users:
  # UUID 是用户标识，用 https://www.uuidgenerator.net/ 生成
  - uuid: 5f3c52f5-21cd-4ed0-97cd-317358d45c5f
    alterId: 0
  transport: # WebSocket 相关配置
    type: ws
    path: "/1f4fa9c7af63f52acbc1a711922bccb4" # 随机生成
    max_early_data: 2048
    early_data_header_name: Sec-WebSocket-Protocol
# 3. VLESS-Vision-Reality
- type: vless
  tag: VL-V-R
  listen: 0.0.0.0
  listen_port: 8443 # 选择常见 HTTP(S) 端口，若 443 被占用选择 8443 等
  sniff: true
  users:
  - uuid: 351b2348-3922-4d01-8b6b-54e5f5ba1413 # 随机生成
    flow: xtls-rprx-vision # Vision 流控
  tls: # REALITY 魔改的 TLS 配置
    enabled: true
    server_name: vvr.example.com # 修改为您的实际域名
    reality:
      enabled: true
      handshake:
        # REALITY 需要选择合适的域名，下面会提到
        server: www.python.com
        server_port: 443
      # 使用 sing-box generate reality-keypair 生成密钥对
      # 记录 PublicKey 如 aQ-WSt7FXgcl-uNjK7z5xEHlZq5ErrlxBMFecsemKzI
      private_key: qNX58DkQcbITuGooZX096kSIaIxMODf6iqhZ2soBiVA
      short_id:
      - d4fc8b05962e33e9 # 随机生成
```

`/etc/nginx/nginx.conf`：

```nginx
# 本配置是通用的安全 NGiNX 配置，不仅仅用于 sing-box

# 运行设置
user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log notice;
pid /var/run/nginx.pid;

# 加载动态模块
include /usr/share/nginx/modules/*.conf;

events {
    worker_connections 1024;
    use epoll; # 高效的请求异步处理算法
    multi_accept on;
}

http {
    # 基础设置
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    server_names_hash_bucket_size 128; # 防止域名过长
    
    # MIME 类型
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    # 安全请求头
    add_header X-Frame-Options SAMEORIGIN always;
    add_header X-Content-Type-Options nosniff always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    
    # 日志格式
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                   '$status $body_bytes_sent "$http_referer" '
                   '"$http_user_agent" "$http_x_forwarded_for"';
    
    # 访问日志
    access_log /var/log/nginx/access.log main;
    
    # Gzip 压缩
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        application/atom+xml
        image/svg+xml;
    
    # TLS 加密设置
    ssl_protocols TLSv1.2 TLSv1.3; # 禁用旧版 TLS
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 1d;
    ssl_session_tickets off;
    
    # 检测证书是否有效
    ssl_stapling on;
    ssl_stapling_verify on;
    
    # 限制客户端访问速率，可选
    # limit_req_zone $binary_remote_addr zone=general:10m rate=10r/s;
    # limit_req_zone $binary_remote_addr zone=login:10m rate=1r/s;
    
    # sing-box 配置需要的常量定义
    map $http_upgrade $connection_upgrade {
        default upgrade;
        ""      close;
    }

    map $remote_addr $proxy_forwarded_elem {
        ~^[0-9.]+$        "for=$remote_addr";
        ~^[0-9A-Fa-f:.]+$ "for=\"[$remote_addr]\"";
        default           "for=unknown";
    }

    map $http_forwarded $proxy_add_forwarded {
        "~^(,[ \\t]*)*([!#$%&'*+.^_`|~0-9A-Za-z-]+=([!#$%&'*+.^_`|~0-9A-Za-z-]+|\"([\\t \\x21\\x23-\\x5B\\x5D-\\x7E\\x80-\\xFF]|\\\\[\\t \\x21-\\x7E\\x80-\\xFF])*\"))?(;([!#$%&'*+.^_`|~0-9A-Za-z-]+=([!#$%&'*+.^_`|~0-9A-Za-z-]+|\"([\\t \\x21\\x23-\\x5B\\x5D-\\x7E\\x80-\\xFF]|\\\\[\\t \\x21-\\x7E\\x80-\\xFF])*\"))?)*([ \\t]*,([ \\t]*([!#$%&'*+.^_`|~0-9A-Za-z-]+=([!#$%&'*+.^_`|~0-9A-Za-z-]+|\"([\\t \\x21\\x23-\\x5B\\x5D-\\x7E\\x80-\\xFF]|\\\\[\\t \\x21-\\x7E\\x80-\\xFF])*\"))?(;([!#$%&'*+.^_`|~0-9A-Za-z-]+=([!#$%&'*+.^_`|~0-9A-Za-z-]+|\"([\\t \\x21\\x23-\\x5B\\x5D-\\x7E\\x80-\\xFF]|\\\\[\\t \\x21-\\x7E\\x80-\\xFF])*\"))?)*)?)*$" "$http_forwarded, $proxy_forwarded_elem";
        default "$proxy_forwarded_elem";
    }

    # 禁止 IP 直接访问
    server {
        listen 80 default_server;
        listen [::]:80 default_server;
        listen 443 ssl default_server;
        listen [::]:443 ssl default_server;
        
        # 可选，可以添加 X.509 自签名证书
        # ssl_certificate /var/cert/dummy/public.crt;
        # ssl_certificate_key /var/cert/dummy/private.key;
        
        server_name _;
        
        # 禁止访问（444）
        return 444;
    }
    
    # HTTP 流量重定向至 HTTPS
    server {
        listen 80;
        listen [::]:80;
        server_name ~^(?!_).*$;
        
        # HTTP 重定向相关安全头
        add_header X-Frame-Options DENY always;
        add_header X-Content-Type-Options nosniff always;
        
        return 301 https://$host$request_uri;
    }
    
    # 客户端设置
    client_max_body_size 64M;
    client_body_timeout 30s;
    client_header_timeout 30s;
    
    # 缓存设置
    client_body_buffer_size 128k;
    client_header_buffer_size 1k;
    large_client_header_buffers 4 4k;
    
    # 隐藏 NGiNX 版本信息
    server_tokens off;
    
    # 导入 conf.d 中其他配置
    include /etc/nginx/conf.d/*.conf;
}
```

`/etc/nginx/conf.d/sing-box.conf`：

```nginx
# 禁止非 HTTP2 访问
server {
    listen 2053 ssl default_server;
    listen [::]:2053 ssl default_server;

    ssl_reject_handshake on;

    ssl_protocols TLSv1.2 TLSv1.3;

    ssl_session_timeout 1h;
    ssl_session_cache shared:SSL:10m;
}

server {
    # Cloudflare 反代端口只支持 443、2053、8443 等
    listen 2053 ssl http2;
    listen [::]:2053 ssl http2;

    server_name vwt.example.com;

    # 替换为您自己的证书
    ssl_certificate /var/cert/vmt.example.com/public.crt;
    ssl_certificate_key /var/cert/vmt.example.com/private.key;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers TLS13_AES_128_GCM_SHA256:TLS13_AES_256_GCM_SHA384:TLS13_CHACHA20_POLY1305_SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305;
    ssl_prefer_server_ciphers  on;

    ssl_stapling on;
    ssl_stapling_verify on;
    # 防止域名解析失败
    resolver 1.1.1.1 valid=60s;
    resolver_timeout 2s;

    client_header_buffer_size 8k;

    # 地址对应 sing-box 配置中 WebSocket 路径
    location = /1f4fa9c7af63f52acbc1a711922bccb4 {
        if ($http_upgrade != "websocket") {
            return 404;
        }

        proxy_pass http://127.0.0.1:6666; # 端口号对应监听的
        proxy_http_version 1.1;
        # 升级为 WebSocket 连接
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $host;
        proxy_redirect off;
    }

    location / {
        sub_filter $proxy_host $host;
        sub_filter_once off;

        # 反代伪装网站
        set $website geo.mirror.pkgbuild.com;
        proxy_pass https://$website;
        resolver 1.1.1.1;

        proxy_set_header Host $proxy_host;

        proxy_http_version 1.1;
        proxy_cache_bypass $http_upgrade;

        proxy_ssl_server_name on;

        # 反代的一些头
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Forwarded $proxy_add_forwarded;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;

        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
}

```

## 注意事项

- 文中所有随机字符串、UUID 强烈建议您自行生成。

- 如果您的服务器开启了防火墙，按照以上配置，您应该开放 8443/tcp、7777/udp、2053/tcp 端口。

- REALITY 伪装域名选择：

  先用 [Ping0](https://ping0.cc) 获取 VPS 的 ASN，访问 [FOFA 搜索引擎](https://en.fofa.info)，用规则

  ```
  asn=="xxxxx" && country=="xx" && port=="443" && cert!="Let's Encrypt" && cert.issuer!="ZeroSSL" && status_code="200"
  ```

  搜索，寻找有域名、证书有效的网站，填入配置文件。

- acme.sh 获取证书，请查看 [使用 acme.sh 获取泛域名证书](/1097746c8f/67c700bfbf.md)，并替换以上地址。

- Warp 代理搭建，请查看 [Warp 代理模式和一些坑](/1097746c8f/67c700bfbf.md)。

## 下课

过不了几天，sing-box 1.12.0 正式版就发布了，这些配置文件又要失效了……
